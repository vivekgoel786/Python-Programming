import pandas as pd
import statsmodels.api as sm

def fit_mnl_models(data, target='Economy_state_dummy', base_category='normal'):
    # Ensure dependent variable is categorical and set the base category
    data[target] = pd.Categorical(data[target])
    data[target] = data[target].cat.reorder_categories([base_category] + 
                              [cat for cat in data[target].cat.categories if cat != base_category],
                              ordered=False)

    results_list = []
    exclude_cols = ['Date', target]
    independent_vars = [col for col in data.columns if col not in exclude_cols]

    for var in independent_vars:
        try:
            # Drop NA rows for this variable
            sub_data = data[[target, var]].dropna()

            # Design X matrix with intercept
            X = sm.add_constant(sub_data[[var]])
            y = sub_data[target]

            model = sm.MNLogit(y, X).fit(disp=False)
            summary = model.summary2().tables[1]
            # Get summary table
summary = model.summary2().tables[1]

# Print to see column names (optional debug step)
# print(summary.columns)

# Determine actual column names to avoid KeyErrors
coef_col = next((c for c in summary.columns if 'Coef' in c), 'coef')
pval_col = next((c for c in summary.columns if 'P' in c), 'P-value')
z_col = next((c for c in summary.columns if 'z' in c or 'Z' in c), 'z')

for coef_label in summary.index:
    results_list.append({
        'Independent_Var': var,
        'Coefficient': coef_label,
        'Beta': summary.loc[coef_label, coef_col],
        'P-Value': summary.loc[coef_label, pval_col],
        'T-Stat': summary.loc[coef_label, z_col],
        'Pseudo_R2': model.prsquared,
        'AIC': model.aic,
        'BIC': model.bic
    })

            for coef_label in summary.index:
                results_list.append({
                    'Independent_Var': var,
                    'Coefficient': coef_label,
                    'Beta': summary.loc[coef_label, 'Coef.'],
                    'P-Value': summary.loc[coef_label, 'P>|z|'],
                    'T-Stat': summary.loc[coef_label, 'z'],
                    'Pseudo_R2': model.prsquared,
                    'AIC': model.aic,
                    'BIC': model.bic
                })

        except Exception as e:
            print(f"Model failed for variable {var}: {e}")

    return pd.DataFrame(results_list)
