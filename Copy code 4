import pandas as pd
import statsmodels.api as sm
from statsmodels.miscmodels.ordinal_model import OrderedModel

def fit_ordered_logit_models(data, target='Economy_State_dummy'):
    # Ensure the dependent variable is categorical and ordered
    ordered_categories = ['Poor', 'Normal', 'Good']
    data[target] = pd.Categorical(data[target], categories=ordered_categories, ordered=True)

    results_list = []
    exclude_cols = ['Date', target]
    independent_vars = [col for col in data.columns if col not in exclude_cols]

    for var in independent_vars:
        try:
            sub_data = data[[target, var]].dropna()
            y = sub_data[target]
            X = sub_data[[var]]

            # Fit Ordered Logit model
            model = OrderedModel(y, X, distr='logit')
            res = model.fit(method='lbfgs', disp=False)

            # Get coefficients (including thresholds)
            for param_name, coef in res.params.items():
                results_list.append({
                    'Independent_Var': var,
                    'Coefficient': param_name,
                    'Beta': coef,
                    'P-Value': res.pvalues[param_name],
                    'T-Stat': res.tvalues[param_name],
                    'Pseudo_R2': res.prsquared if hasattr(res, 'prsquared') else None,
                    'AIC': res.aic,
                    'BIC': res.bic,
                    "Log-Likelihood" : res.llf,
                    "Nobs": res.nobs
                })

        except Exception as e:
            print(f"Model failed for variable {var}: {e}")

    return pd.DataFrame(results_list)
